ИТМО Университет  
Факультет программной инженерии и компьютерной техники  
Дисциплина: Коммуникационные сервисы  

Лабораторная работа №2  
**Тема:** Логирование, мониторинг и визуализация на примере Nextcloud, Loki, Zabbix и Grafana  

Студент: ______________________________  
Группа:  ______________________________  
Преподаватель: ________________________  

Санкт-Петербург, 2025 г.

---

## Цель работы

Изучить на практике, как строится система логирования, мониторинга и визуализации состояния веб‑сервиса на примере стека:
- Nextcloud как тестовое web‑приложение;
- Loki + Promtail для централизованного сбора и хранения логов;
- Zabbix для мониторинга доступности и состояния сервиса;
- Grafana для визуализации логов и метрик.

---

## Используемое ПО

- Docker, Docker Compose  
- Nextcloud (`nextcloud:29.0.6`)  
- Grafana Loki (`grafana/loki:2.9.0`)  
- Promtail (`grafana/promtail:2.9.0`)  
- Grafana (`grafana/grafana:11.2.0`)  
- PostgreSQL 15 (БД для Zabbix)  
- Zabbix Server + Zabbix Web (`zabbix/zabbix-server-pgsql:ubuntu-6.4-latest`, `zabbix/zabbix-web-nginx-pgsql:ubuntu-6.4-latest`)

---

## Ход работы

Все скриншоты приложены в папке `screenshots` и пронумерованы по порядку выполнения шагов.

### 1. Подготовка окружения и запуск docker-compose

1. **Подключение к удалённой машине по SSH.**  
   Выполнено подключение к серверу, на котором разворачивается лабораторный стенд.

   ![SSH‑подключение](screenshots/1.png)

2. **Передача файлов на удалённый сервер.**  
   Через SCP/SSH были загружены исходные файлы лабораторной работы, включая `docker-compose.yml` и конфигурации.

   ![Передача файлов](screenshots/2.png)

3. **Запуск `docker-compose` для развёртывания стенда.**  
   В каталоге с проектом выполнена команда `docker compose up -d` для поднятия всех контейнеров.

   ![Запуск docker-compose](screenshots/3.png)

4. **Проверка запущенных контейнеров.**  
   Командой `docker compose ps`/`docker ps` проверено, что все сервисы (Nextcloud, Loki, Promtail, Grafana, Zabbix, PostgreSQL) работают.

   ![Список контейнеров](screenshots/4.png)

5. **Проверка/настройка сетевых портов.**  
   Убедился, что порты 8080 (Nextcloud), 3000 (Grafana), 8082 (Zabbix Web), 3100 (Loki) и др. доступны с рабочей машины.

   ![Открытые порты](screenshots/5.png)

---

### 2. Инициализация Nextcloud и генерация логов

6. **Мастер установки Nextcloud.**  
   В браузере открыт адрес `http://<host>:8080`, запущен мастер начальной настройки Nextcloud.

   ![Мастер установки Nextcloud](screenshots/6.png)

7. **Создание учётной записи администратора.**  
   Заданы логин и пароль администратора, выбрана конфигурация БД (для простоты — встроенная).

   ![Создание учётной записи](screenshots/7.png)

8. **Проверка работы интерфейса Nextcloud.**  
   После завершения установки открыта главная страница, подтверждена корректная работа сервиса.

   ![Главная страница Nextcloud](screenshots/8.png)

9. **Действия пользователя для генерации логов.**  
   В веб‑интерфейсе выполнены операции (загрузка и удаление файлов, навигация по меню), чтобы в системе появились реальные логи.

   ![Работа с файлами в Nextcloud](screenshots/9.png)

---

### 3. Логирование: Promtail и Loki

10. **Настройка Promtail для сбора логов.**  
    Promtail сконфигурирован на чтение логов Nextcloud из подключённого тома и отправку их в Loki.  
    В конфигурации (`promtail_config.yml`) указаны:
    - путь к файлам логов Nextcloud;
    - клиент `http://loki:3100/loki/api/v1/push`;
    - файл хранения позиций.

    ![Настройки Promtail](screenshots/10.png)

11. **Проверка статуса Promtail и структуры конфигурации.**  
    На уровне интерфейса/конфигов проверено, что все нужные каталоги и лейблы для логов заданы корректно.

    ![Подборка настроек Promtail](screenshots/11.png)

12. **Проверка того, что Loki принимает данные.**  
    На стороне Loki выполнена проверка статуса и наличия загруженных записей (healthcheck/первые запросы к API).

    ![Статус Loki/приём данных](screenshots/12.png)

13. **Просмотр логов через интерфейс (Loki / Grafana).**  
    В веб‑интерфейсе (через интеграцию с Loki) отображены потоки логов Nextcloud, что подтверждает корректную работу цепочки Nextcloud → Promtail → Loki.

    ![Просмотр логов](screenshots/13.png)

14. **Логи в виде таблицы с фильтрацией.**  
    С помощью фильтров по лейблам в Loki настроен табличный вид логов, что позволяет быстро находить нужные записи.

    ![Логи в виде таблицы и фильтры](screenshots/14.png)

15. **Формирование PromQL‑запроса через Builder.**  
    В интерфейсе построителя запросов сформирован запрос PromQL к логам/метрикам.

    ![PromQL‑запрос через Builder](screenshots/25.png)

16. **Результат выполнения PromQL‑запроса.**  
    Отображён результат запроса (график/таблица), подтверждающий, что данные из Loki успешно обрабатываются.

    ![Результат PromQL‑запроса](screenshots/26.png)

---

### 4. Мониторинг Nextcloud в Zabbix

17. **Вход в веб‑интерфейс Zabbix.**  
    Доступ к Zabbix Web осуществляется по `http://<host>:8082`, выполнен вход под учётной записью администратора.

    ![Вход в Zabbix](screenshots/15.png)

18. **Навигация к разделу шаблонов.**  
    Открыт раздел `Configuration → Templates` для импорта собственного шаблона мониторинга Nextcloud.

    ![Навигация к шаблонам](screenshots/16.png)

19. **Импорт шаблона мониторинга Nextcloud.**  
    Через интерфейс импортирован подготовленный файл `template.yml`, содержащий элемент данных `HTTP_AGENT`, обращающийся к `status.php` Nextcloud и интерпретирующий поле `maintenance`.

    ![Импорт шаблона](screenshots/17.png)

20. **Переход в раздел хостов.**  
    Открыт `Configuration → Hosts` для создания нового хоста, соответствующего экземпляру Nextcloud.

    ![Навигация к хостам](screenshots/18.png)

21. **Создание хоста и привязка шаблона.**  
    Создан новый хост с указанием имени/адреса сервера Nextcloud, к нему привязан импортированный шаблон.

    ![Создание хоста](screenshots/19.png)

22. **Проверка, что хост активен.**  
    В списке хостов проверен статус подключения и отсутствие ошибок.

    ![Хост сконфигурирован](screenshots/20.png)

23. **Просмотр последних данных (Latest data).**  
    В разделе `Monitoring → Latest data` отображаются значения по элементам данных (в том числе результат `nextcloud.ping`).

    ![Последние данные по хосту](screenshots/21.png)

24. **Мониторинг метрик Nextcloud.**  
    Отдельные графики и таблицы показывают, что данные по доступности и состоянию Nextcloud регулярно обновляются.

    ![Мониторинг в Zabbix](screenshots/22.png)

25. **Сработавший триггер при переходе в maintenance.**  
    При включении режима обслуживания или нарушении доступности статус меняется на `unhealthy`, в Zabbix срабатывает триггер с высоким приоритетом.

    ![Сработавший триггер](screenshots/23.png)

26. **Общий статус сервера и сервисов.**  
    На сводных панелях Zabbix отображается агрегированная информация о состоянии хоста и связанных сервисов.

    ![Статус сервера](screenshots/24.png)

---

### 5. Визуализация в Grafana

27. **Первичный вход в Grafana.**  
    В браузере открыт интерфейс Grafana по адресу `http://<host>:3000`, выполнен вход под администратором.

    ![Интерфейс Grafana](screenshots/20.png)

28. **Настройка источника данных Loki.**  
    В разделе `Configuration → Data Sources` добавлен источник типа **Loki** с URL `http://loki:3100`, подключение успешно протестировано.

    ![Источник данных Loki](screenshots/27.png)

29. **Настройка источника данных Zabbix (через плагин).**  
    После установки плагина Zabbix добавлен источник данных, указаны URL API Zabbix и учётные данные.

    ![Источник данных Zabbix](screenshots/28.png)

30. **Создание дашбордов.**  
    В Grafana созданы панели:
    - с логами Nextcloud из Loki;
    - с метриками доступности из Zabbix;
    - комбинированные панели для совместного анализа логов и метрик.

    ![Пример дашборда](screenshots/24.png)

---

## Ответы на контрольные вопросы

**1. Чем SLO отличается от SLA?**

- **SLA (Service Level Agreement)** – юридическое соглашение между поставщиком услуг и клиентом, определяющее условия предоставления услуги (например, минимальную доступность 99,9 %). При нарушении SLA возможны штрафы и другие санкции.  
- **SLO (Service Level Objective)** – внутренние целевые значения метрик для команды эксплуатации/разработки (например, целевая доступность 99,95 %). Это цель, к которой стремится команда, но не обязательно формальное юридическое обязательство перед клиентом.

---

**2. Чем отличается инкрементальный бэкап от дифференциального?**

- **Дифференциальный бэкап** – копируются все данные, изменённые с момента последнего полного бэкапа. Для восстановления нужны последний полный бэкап и последний дифференциальный.  
- **Инкрементальный бэкап** – копируются данные, изменённые с момента любого последнего бэкапа (полного или инкрементального). Для восстановления нужны последний полный бэкап и вся цепочка инкрементальных бэкапов. Инкрементальные копии обычно меньше по размеру, но восстановление сложнее и дольше.

---

**3. В чём разница между мониторингом и observability?**

- **Мониторинг** – реактивный подход: наблюдение за заранее определёнными метриками и состояниями (CPU, RAM, ошибки, аптайм, статус сервиса и т.п.). Позволяет понять, «всё ли сейчас в пределах нормальных значений».  
- **Observability (наблюдаемость)** – проактивный подход: способность по логам, метрикам и трассировкам понять внутреннее состояние сложной системы и причину проблемы, даже если она заранее не была описана. Даёт возможность отвечать на вопрос «почему система ведёт себя именно так?».

---

## Вывод

В ходе лабораторной работы был развёрнут комплекс сервисов для логирования, мониторинга и визуализации состояния веб‑приложения Nextcloud с использованием Docker Compose.  
Promtail настроен на чтение лог‑файлов Nextcloud и отправку их в Loki, благодаря чему логи доступны для анализа и поиска в едином центре.  
Система мониторинга Zabbix использует HTTP‑агента для проверки состояния Nextcloud через `status.php` и реагирует на режим обслуживания с помощью триггера.  
В Grafana созданы дашборды на основе данных Loki и Zabbix, позволяющие наблюдать за логами и метриками в одном интерфейсе и быстро выявлять и анализировать инциденты.


